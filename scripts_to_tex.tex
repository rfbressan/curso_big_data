% Options for packages loaded elsewhere
\PassOptionsToPackage{unicode}{hyperref}
\PassOptionsToPackage{hyphens}{url}
%
\documentclass[
]{article}
\usepackage{lmodern}
\usepackage{amssymb,amsmath}
\usepackage{ifxetex,ifluatex}
\ifnum 0\ifxetex 1\fi\ifluatex 1\fi=0 % if pdftex
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provide euro and other symbols
\else % if luatex or xetex
  \usepackage{unicode-math}
  \defaultfontfeatures{Scale=MatchLowercase}
  \defaultfontfeatures[\rmfamily]{Ligatures=TeX,Scale=1}
\fi
% Use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\IfFileExists{microtype.sty}{% use microtype if available
  \usepackage[]{microtype}
  \UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\makeatletter
\@ifundefined{KOMAClassName}{% if non-KOMA class
  \IfFileExists{parskip.sty}{%
    \usepackage{parskip}
  }{% else
    \setlength{\parindent}{0pt}
    \setlength{\parskip}{6pt plus 2pt minus 1pt}}
}{% if KOMA class
  \KOMAoptions{parskip=half}}
\makeatother
\usepackage{xcolor}
\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
\IfFileExists{bookmark.sty}{\usepackage{bookmark}}{\usepackage{hyperref}}
\hypersetup{
  pdftitle={Untitled},
  pdfauthor={Rafael},
  hidelinks,
  pdfcreator={LaTeX via pandoc}}
\urlstyle{same} % disable monospaced font for URLs
\usepackage[margin=1in]{geometry}
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.77,0.63,0.00}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\usepackage{graphicx,grffile}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
% Set default figure placement to htbp
\makeatletter
\def\fps@figure{htbp}
\makeatother
\setlength{\emergencystretch}{3em} % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{-\maxdimen} % remove section numbering

\title{Untitled}
\author{Rafael}
\date{06/01/2021}

\begin{document}
\maketitle

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{#' Analise e replicacao de alguns resultados em Fellner et all (2013)}
\CommentTok{#' Autor: Rafael Felipe Bressan}
\CommentTok{#' Arquivo: script_R.R}
\CommentTok{#' Script R para o trabalho monografico: Inferência Causal com Machine Learning}
\CommentTok{#' uma aplicacao para evasao fiscal}
\CommentTok{#' Pós-Graduacao Lato Sensu em Ciencia de Dados e Big Data PUC-MG}
\CommentTok{#' Ano: 2021}
\CommentTok{#' }
\CommentTok{#' Carrega as bibliotecas}
\KeywordTok{library}\NormalTok{(sandwich)}
\KeywordTok{library}\NormalTok{(fixest)}
\KeywordTok{library}\NormalTok{(tidyverse)}
\KeywordTok{library}\NormalTok{(glue)}
\KeywordTok{library}\NormalTok{(skimr)}
\KeywordTok{library}\NormalTok{(knitr)}
\KeywordTok{library}\NormalTok{(kableExtra)}
\KeywordTok{library}\NormalTok{(stargazer)}
\KeywordTok{library}\NormalTok{(texreg)}

\CommentTok{#' Tabela 1 com a descricao das variaveis}
\NormalTok{desc_tbl <-}\StringTok{ }\KeywordTok{read_csv}\NormalTok{(}\StringTok{"descricao.csv"}\NormalTok{)}

\KeywordTok{kbl}\NormalTok{(desc_tbl, }\DataTypeTok{booktabs =} \OtherTok{TRUE}\NormalTok{, }\DataTypeTok{longtable =} \OtherTok{TRUE}\NormalTok{, }\DataTypeTok{format =} \StringTok{"latex"}\NormalTok{,}
    \DataTypeTok{col.names =} \KeywordTok{c}\NormalTok{(}\StringTok{"Variável"}\NormalTok{, }\StringTok{"Descrição"}\NormalTok{),}
    \DataTypeTok{caption =} \StringTok{"Variáveis e descrições"}\NormalTok{,}
    \DataTypeTok{label =} \StringTok{"descricao"}\NormalTok{) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{kable_styling}\NormalTok{(}\DataTypeTok{full_width =} \OtherTok{FALSE}\NormalTok{, }
                \DataTypeTok{latex_options =} \KeywordTok{c}\NormalTok{(}\StringTok{"repeat_header"}\NormalTok{),}
                \DataTypeTok{repeat_header_text =} \StringTok{"(continuação)"}\NormalTok{) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{column_spec}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DataTypeTok{width =} \StringTok{"30em"}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{save_kable}\NormalTok{(}\DataTypeTok{file =} \StringTok{"./Tables/table_descricao.tex"}\NormalTok{)}

\CommentTok{#' Carregando os dados}
\NormalTok{data <-}\StringTok{ }\NormalTok{haven}\OperatorTok{::}\KeywordTok{read_dta}\NormalTok{(}\StringTok{"data_final.dta"}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{as.data.frame}\NormalTok{()}

\CommentTok{# Descrevendo o desenho do experimento --------------------------------}

\CommentTok{#' Tabela contando o numero de recipientes de cada tratamento}
\CommentTok{#'}
\NormalTok{data}\OperatorTok{$}\NormalTok{treatment <-}\StringTok{ }\KeywordTok{factor}\NormalTok{(data}\OperatorTok{$}\NormalTok{treatment)}
\NormalTok{t_sizes <-}\StringTok{ }\KeywordTok{as.vector}\NormalTok{(}\KeywordTok{table}\NormalTok{(data}\OperatorTok{$}\NormalTok{treatment))}

\NormalTok{buckets <-}\StringTok{ }\KeywordTok{data.frame}\NormalTok{(}\DataTypeTok{treatment =} \KeywordTok{sort}\NormalTok{(}\KeywordTok{unique}\NormalTok{(data}\OperatorTok{$}\NormalTok{treatment)),}
                      \DataTypeTok{Buckets =} \KeywordTok{c}\NormalTok{(}\StringTok{"T0"}\NormalTok{, }\StringTok{"T1"}\NormalTok{, }\StringTok{"T2"}\NormalTok{, }\StringTok{"T3"}\NormalTok{, }\StringTok{"T4"}\NormalTok{, }\StringTok{"T5"}\NormalTok{, }\StringTok{"T6"}\NormalTok{),}
                      \DataTypeTok{Description =} \KeywordTok{c}\NormalTok{(}\StringTok{"Sem Correio"}\NormalTok{, }\StringTok{"Correio"}\NormalTok{, }\StringTok{"Ameaça"}\NormalTok{, }\StringTok{"Info"}\NormalTok{,}
                                      \StringTok{"Info&Ameaça"}\NormalTok{, }\StringTok{"Moral"}\NormalTok{, }\StringTok{"Moral&Ameaça"}\NormalTok{),}
                      \DataTypeTok{Size =}\NormalTok{ t_sizes) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{Prop =}\NormalTok{ Size }\OperatorTok{/}\StringTok{ }\KeywordTok{nrow}\NormalTok{(data))}

\CommentTok{#' Tabela 2 recipientes de cada tratamento}
\KeywordTok{kbl}\NormalTok{(buckets[}\OperatorTok{-}\DecValTok{1}\NormalTok{], }\DataTypeTok{format =} \StringTok{"latex"}\NormalTok{, }\DataTypeTok{booktabs =} \OtherTok{TRUE}\NormalTok{, }\DataTypeTok{label =} \StringTok{"descritivas1"}\NormalTok{,}
    \DataTypeTok{col.names =} \KeywordTok{c}\NormalTok{(}\StringTok{"Tratamento"}\NormalTok{, }\StringTok{"Descrição"}\NormalTok{, }\StringTok{"Observações"}\NormalTok{, }\StringTok{"Proporção"}\NormalTok{),}
    \DataTypeTok{caption =} \StringTok{"Distribuição dos tratamentos na amostra."}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{kable_styling}\NormalTok{(}\DataTypeTok{latex_options =} \KeywordTok{c}\NormalTok{(}\StringTok{"HOLD_position"}\NormalTok{)) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{kable_classic}\NormalTok{(}\DataTypeTok{full_width =} \OtherTok{FALSE}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{save_kable}\NormalTok{(}\StringTok{"./Tables/table_descritivas1.tex"}\NormalTok{)}

\CommentTok{#' Junta de volta as inforamacoes de bucket e descricao para os dados}
\NormalTok{data <-}\StringTok{ }\NormalTok{data }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{left_join}\NormalTok{(buckets[, }\KeywordTok{c}\NormalTok{(}\StringTok{"treatment"}\NormalTok{, }\StringTok{"Buckets"}\NormalTok{, }\StringTok{"Description"}\NormalTok{)], }\DataTypeTok{by =} \StringTok{"treatment"}\NormalTok{)}
\CommentTok{#' Estatisticas descritivas da base}
\CommentTok{#' Variaveis com valor NA}
\NormalTok{skim_df <-}\StringTok{ }\NormalTok{data }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{skim_without_charts}\NormalTok{()}

\NormalTok{na_df <-}\StringTok{ }\NormalTok{skim_df }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(n_missing }\OperatorTok{>}\StringTok{ }\DecValTok{0}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{select}\NormalTok{(skim_variable, n_missing, complete_rate)}

\CommentTok{#' Tabela 3 dados faltantes}
\KeywordTok{kbl}\NormalTok{(na_df, }\DataTypeTok{digits =} \DecValTok{2}\NormalTok{, }\DataTypeTok{format =} \StringTok{"latex"}\NormalTok{, }\DataTypeTok{booktabs =} \OtherTok{TRUE}\NormalTok{, }\DataTypeTok{label =} \StringTok{"missings"}\NormalTok{,}
    \DataTypeTok{col.names =} \KeywordTok{c}\NormalTok{(}\StringTok{"Variável"}\NormalTok{, }\StringTok{"No. Faltantes"}\NormalTok{, }\StringTok{"Completude"}\NormalTok{),}
    \DataTypeTok{caption =} \StringTok{"Dados faltantes na amostra."}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{kable_styling}\NormalTok{(}\DataTypeTok{latex_options =} \KeywordTok{c}\NormalTok{(}\StringTok{"HOLD_position"}\NormalTok{)) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{kable_classic}\NormalTok{(}\DataTypeTok{full_width =} \OtherTok{FALSE}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{footnote}\NormalTok{(}\DataTypeTok{general_title =} \StringTok{"Nota:"}\NormalTok{,}
           \DataTypeTok{general =} \StringTok{"Completude refere-se a proporção de linhas preenchidas contra faltantes, e varia de zero a um."}\NormalTok{,}
           \DataTypeTok{threeparttable =} \OtherTok{TRUE}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{save_kable}\NormalTok{(}\StringTok{"./Tables/table_missings.tex"}\NormalTok{)}

\CommentTok{#' Analise Exploratoria}
\CommentTok{#' Problema de atrito}
\NormalTok{attrition_level <-}\StringTok{ }\NormalTok{data }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(mailing }\OperatorTok{==}\StringTok{ }\DecValTok{1}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{group_by}\NormalTok{(treatment, Buckets, Description) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{summarise}\NormalTok{(}\DataTypeTok{mail_count =} \KeywordTok{n}\NormalTok{(),}
            \DataTypeTok{deliv_na_count =} \KeywordTok{sum}\NormalTok{(}\KeywordTok{is.na}\NormalTok{(delivered)),}
            \DataTypeTok{deliv_0_count =} \KeywordTok{sum}\NormalTok{(delivered }\OperatorTok{==}\StringTok{ }\DecValTok{0}\NormalTok{),}
            \DataTypeTok{attr_rate =}\NormalTok{ (deliv_na_count }\OperatorTok{+}\StringTok{ }\NormalTok{deliv_}\DecValTok{0}\NormalTok{_count) }\OperatorTok{/}\StringTok{ }\KeywordTok{nrow}\NormalTok{(}\KeywordTok{cur_data}\NormalTok{()))}
\NormalTok{chi_test <-}\StringTok{ }\KeywordTok{chisq.test}\NormalTok{(attrition_level}\OperatorTok{$}\NormalTok{deliv_}\DecValTok{0}\NormalTok{_count, }
                       \DataTypeTok{p =}\NormalTok{ attrition_level}\OperatorTok{$}\NormalTok{mail_count, }\DataTypeTok{rescale.p =} \OtherTok{TRUE}\NormalTok{)}
\NormalTok{atrito_foot <-}\StringTok{ }\KeywordTok{glue}\NormalTok{(}\StringTok{"Na média total a taxa de atrito foi de \{format(mean(attrition_level$attr_rate), digits = 4)\} e não houve diferença entre tratamentos, como aponta o teste qui-quadrado de Pearson para dados de contagem, com p-valor de \{format(chi_test$p.value, digits = 4)\}."}\NormalTok{)}
\CommentTok{#' Tabela 5 detalhando o nivel de atrito por tratamento}
\KeywordTok{kbl}\NormalTok{(attrition_level[}\OperatorTok{-}\DecValTok{1}\NormalTok{], }\DataTypeTok{digits =} \DecValTok{4}\NormalTok{, }\DataTypeTok{format =} \StringTok{"latex"}\NormalTok{, }\DataTypeTok{booktabs =} \OtherTok{TRUE}\NormalTok{, }
    \DataTypeTok{label =} \StringTok{"atrito-level"}\NormalTok{, }
    \DataTypeTok{col.names =} \KeywordTok{c}\NormalTok{(}\StringTok{"Tratamento"}\NormalTok{, }\StringTok{"Descrição"}\NormalTok{, }\StringTok{"Cartas"}\NormalTok{, }\StringTok{"Entregues NA"}\NormalTok{, }
                  \StringTok{"Não Entregues"}\NormalTok{, }\StringTok{"Taxa Atrito"}\NormalTok{),}
    \DataTypeTok{caption =} \StringTok{"Taxa de atrito por tratamento."}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{kable_styling}\NormalTok{(}\DataTypeTok{latex_options =} \KeywordTok{c}\NormalTok{(}\StringTok{"HOLD_position"}\NormalTok{)) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{kable_classic}\NormalTok{(}\DataTypeTok{full_width =} \OtherTok{FALSE}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{footnote}\NormalTok{(}\DataTypeTok{general_title =} \StringTok{"Nota:"}\NormalTok{, }\DataTypeTok{general =}\NormalTok{ atrito_foot,}
           \DataTypeTok{threeparttable =} \OtherTok{TRUE}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{save_kable}\NormalTok{(}\StringTok{"./Tables/table_atrito_level.tex"}\NormalTok{)}
\CommentTok{#' Todos os NAs se referem ao grupo de controle, mas houve um pouco de atrito.}
\CommentTok{#' Verificar balanceamento de variaveis para aqueles que atritaram}
\NormalTok{atrito_controle <-}\StringTok{ }\NormalTok{data }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(mailing }\OperatorTok{==}\StringTok{ }\DecValTok{0} \OperatorTok{|}\StringTok{ }\NormalTok{(mailing }\OperatorTok{==}\StringTok{ }\DecValTok{1} \OperatorTok{&}\StringTok{ }\NormalTok{delivered }\OperatorTok{==}\StringTok{ }\DecValTok{0}\NormalTok{))}

\NormalTok{attr_bal <-}\StringTok{ }\NormalTok{atrito_controle }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{group_by}\NormalTok{(treatment, Buckets) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{summarise}\NormalTok{(}\KeywordTok{across}\NormalTok{(}\KeywordTok{c}\NormalTok{(gender, age_aver, inc_aver, pop2005, pop_density2005, }
\NormalTok{                     compliance), }
\NormalTok{                   mean, }\DataTypeTok{na.rm =} \OtherTok{TRUE}\NormalTok{))}
\CommentTok{#' Teste anova para diferenca de medias}
\NormalTok{attr_anova <-}\StringTok{ }\KeywordTok{tibble}\NormalTok{(}\DataTypeTok{var =} \KeywordTok{c}\NormalTok{(}\StringTok{"gender"}\NormalTok{, }\StringTok{"age_aver"}\NormalTok{, }\StringTok{"inc_aver"}\NormalTok{, }\StringTok{"pop2005"}\NormalTok{, }
                                    \StringTok{"pop_density2005"}\NormalTok{, }\StringTok{"compliance"}\NormalTok{)) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{rowwise}\NormalTok{() }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{anov =} \KeywordTok{list}\NormalTok{(}\KeywordTok{anova}\NormalTok{(}\KeywordTok{lm}\NormalTok{(}\KeywordTok{paste0}\NormalTok{(var, }\StringTok{"~treatment"}\NormalTok{), }\DataTypeTok{data =}\NormalTok{ atrito_controle))),}
         \DataTypeTok{pval =}\NormalTok{ anov[}\StringTok{"treatment"}\NormalTok{, }\StringTok{"Pr(>F)"}\NormalTok{]) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{select}\NormalTok{(var,pval) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{pivot_wider}\NormalTok{(}\DataTypeTok{names_from =}\NormalTok{ var, }\DataTypeTok{values_from =}\NormalTok{ pval) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{add_column}\NormalTok{(}\DataTypeTok{Buckets =} \StringTok{"Anova p-valor"}\NormalTok{, }\DataTypeTok{.before =} \DecValTok{1}\NormalTok{)}

\NormalTok{atr_bal_foot <-}\StringTok{ "Gênero igual a zero para mulher. Demais variáveis são denominadas em nível municipal, por exemplo Idade refere-se a idade média dos habitantes do município de residência do indivíduo."}
\CommentTok{#' Tabela 6 balanceamento com atrito}
\NormalTok{attr_bal[}\OperatorTok{-}\DecValTok{1}\NormalTok{] }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{bind_rows}\NormalTok{(attr_anova) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{kbl}\NormalTok{(}\DataTypeTok{digits =} \DecValTok{4}\NormalTok{, }\DataTypeTok{format =} \StringTok{"latex"}\NormalTok{, }\DataTypeTok{booktabs =} \OtherTok{TRUE}\NormalTok{, }\DataTypeTok{label =} \StringTok{"atrito-bal"}\NormalTok{,}
      \DataTypeTok{col.names =} \KeywordTok{c}\NormalTok{(}\StringTok{"Tratamento"}\NormalTok{, }\StringTok{"Gênero", "}\NormalTok{Idade}\StringTok{", "}\NormalTok{Renda}\StringTok{", "}\NormalTok{População}\StringTok{", }
\StringTok{                    "}\NormalTok{Dens. pop.}\StringTok{", "}\NormalTok{Compliance}\StringTok{"),}
\StringTok{      caption = "}\NormalTok{Análise de atrito. Balanceamento de variáveis selecionadas}\StringTok{") %>% }
\StringTok{  kable_styling(latex_options = c("}\NormalTok{HOLD_position}\StringTok{")) %>% }
\StringTok{  kable_classic(full_width = FALSE) %>% }
\StringTok{  footnote(general_title = "}\NormalTok{Nota}\OperatorTok{:}\StringTok{",}
\StringTok{           threeparttable = TRUE,}
\StringTok{           general = atr_bal_foot) %>% }
\StringTok{  save_kable("}\NormalTok{.}\OperatorTok{/}\NormalTok{Tables}\OperatorTok{/}\NormalTok{table_atrito_bal.tex}\StringTok{")}
\StringTok{#' Histograma com designacao de tratamento e atrito}
\StringTok{hist1 <- data %>% }
\StringTok{  filter(treatment %in% c("}\DecValTok{0}\StringTok{", "}\DecValTok{6}\StringTok{"), pop_density2005 < 30) %>% }
\StringTok{  select(treatment, pop_density2005) %>% }
\StringTok{  ggplot(aes(x = pop_density2005, y = ..density.., fill = treatment)) +}
\StringTok{  geom_histogram(bins = 50, alpha = 0.8, position = "}\NormalTok{dodge}\StringTok{") +}
\StringTok{  labs(x = "",}
\StringTok{       y = "}\NormalTok{Frequência relativa}\StringTok{",}
\StringTok{       title = "}\NormalTok{Tratamento designado}\StringTok{") +}
\StringTok{  guides(fill = guide_legend(title = "}\NormalTok{Tratamento}\StringTok{")) +}
\StringTok{  scale_fill_discrete(type = c("}\NormalTok{blue}\StringTok{", "}\NormalTok{red}\StringTok{")) +}
\StringTok{  theme_classic()}

\StringTok{hist2 <- atrito_controle %>% }
\StringTok{  filter(treatment %in% c("}\DecValTok{0}\StringTok{", "}\DecValTok{6}\StringTok{"), pop_density2005 < 30) %>% }
\StringTok{  select(treatment, pop_density2005) %>% }
\StringTok{  ggplot(aes(x = pop_density2005, y = ..density.., fill = treatment)) +}
\StringTok{  geom_histogram(bins = 50, alpha = 0.8, position = "}\NormalTok{dodge}\StringTok{") +}
\StringTok{  labs(x = "}\NormalTok{Densidade }\KeywordTok{Populacional}\NormalTok{ (hab}\OperatorTok{/}\NormalTok{km2)}\StringTok{",}
\StringTok{       y = "}\NormalTok{Frequência relativa}\StringTok{",}
\StringTok{       title = "}\NormalTok{Atrito}\StringTok{") +}
\StringTok{  guides(fill = guide_legend(title = "}\NormalTok{Tratamento}\StringTok{")) +}
\StringTok{  scale_fill_discrete(type = c("}\NormalTok{blue}\StringTok{", "}\NormalTok{red}\StringTok{")) +}
\StringTok{  theme_classic()}
\StringTok{png("}\NormalTok{.}\OperatorTok{/}\NormalTok{Figs}\OperatorTok{/}\NormalTok{fig_atr_hist.png}\StringTok{")}
\StringTok{gridExtra::grid.arrange(hist1, hist2)}
\StringTok{dev.off()}

\StringTok{#' Replicacao das tabelas 1 e 2 de Fellner et al.}
\StringTok{#' }
\StringTok{#' Tabela 1}
\StringTok{gtab1 <- data %>% }
\StringTok{  group_by(treatment, Buckets, Description) %>% }
\StringTok{  summarise(across(c(gender, age_aver, inc_aver, pop2005, }
\StringTok{                     pop_density2005, compliance),}
\StringTok{                   mean, na.rm = TRUE))}

\StringTok{anova_results <- data.frame(var = c("}\NormalTok{gender}\StringTok{", "}\NormalTok{age_aver}\StringTok{", "}\NormalTok{inc_aver}\StringTok{", "}\NormalTok{pop2005}\StringTok{", }
\StringTok{                                    "}\NormalTok{pop_density2005}\StringTok{", "}\NormalTok{compliance}\StringTok{")) %>% }
\StringTok{  rowwise() %>% }
\StringTok{  mutate(anov = list(anova(lm(paste0(var, "}\OperatorTok{~}\NormalTok{treatment}\StringTok{"), data = data))),}
\StringTok{         pval = anov["}\NormalTok{treatment}\StringTok{", "}\KeywordTok{Pr}\NormalTok{(}\OperatorTok{>}\NormalTok{F)}\StringTok{"])}
\StringTok{anov_row <- anova_results %>% }
\StringTok{  select(-anov) %>% }
\StringTok{  pivot_wider(names_from = var, values_from = pval) %>% }
\StringTok{  mutate(Buckets = "}\NormalTok{Anova}\OperatorTok{:}\StringTok{ ",}
\StringTok{         Description = "}\NormalTok{p}\OperatorTok{-}\NormalTok{values}\StringTok{") %>% }
\StringTok{  select(Buckets, Description, everything())}

\StringTok{#' Tabela 4 balanceamento. Table 1 de Fellner et. al}
\StringTok{tbl1_cap <- "}\NormalTok{Balanceamento de características individuais e por município por tipo de tratamento.}\StringTok{"}
\StringTok{gtab1[-1] %>% }
\StringTok{  bind_rows(anov_row) %>% }
\StringTok{  kbl(digits = 4, booktabs = TRUE, format = "}\NormalTok{latex}\StringTok{", label = "}\NormalTok{tab1}\StringTok{",     }
\StringTok{      col.names = c("}\NormalTok{Tratamento}\StringTok{", "}\NormalTok{Descrição}\StringTok{", "}\NormalTok{Gênero", }\StringTok{"Idade"}\NormalTok{, }\StringTok{"Renda"}\NormalTok{,}
                    \StringTok{"População"}\NormalTok{, }\StringTok{"Dens. pop."}\NormalTok{, }\StringTok{"Compliance"}\NormalTok{),}
      \DataTypeTok{caption =}\NormalTok{ tbl1_cap) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{kable_styling}\NormalTok{(}\DataTypeTok{latex_options =} \StringTok{"HOLD_position"}\NormalTok{, }\DataTypeTok{font_size =} \DecValTok{10}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{kable_classic}\NormalTok{(}\DataTypeTok{full_width =} \OtherTok{FALSE}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{footnote}\NormalTok{(}\DataTypeTok{general_title =} \StringTok{"Nota:"}\NormalTok{,}
           \DataTypeTok{threeparttable =} \OtherTok{TRUE}\NormalTok{,}
           \DataTypeTok{general =}\NormalTok{ atr_bal_foot) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{save_kable}\NormalTok{(}\DataTypeTok{file =} \StringTok{"./Tables/table1.tex"}\NormalTok{)}

\CommentTok{#' Regressoes da Tabela 7}
\CommentTok{#' }
\NormalTok{reg_}\DecValTok{21}\NormalTok{ <-}\StringTok{ }\KeywordTok{feols}\NormalTok{(resp_A}\OperatorTok{~}\NormalTok{mailing}\OperatorTok{+}\NormalTok{threat}\OperatorTok{+}\NormalTok{appeal}\OperatorTok{+}\NormalTok{info, }\DataTypeTok{data =}\NormalTok{ data)}
\NormalTok{reg_}\DecValTok{22}\NormalTok{ <-}\StringTok{ }\KeywordTok{feols}\NormalTok{(resp_A}\OperatorTok{~}\NormalTok{mailing}\OperatorTok{+}\NormalTok{threat}\OperatorTok{+}\NormalTok{appeal}\OperatorTok{+}\NormalTok{info}\OperatorTok{+}\NormalTok{i_tinf}\OperatorTok{+}\NormalTok{i_tapp, }\DataTypeTok{data =}\NormalTok{ data)}

\NormalTok{delivered <-}\StringTok{ }\NormalTok{data }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(delivered }\OperatorTok{==}\StringTok{ }\DecValTok{1}\NormalTok{)}
\NormalTok{reg_}\DecValTok{23}\NormalTok{ <-}\StringTok{ }\KeywordTok{feols}\NormalTok{(resp_B}\OperatorTok{~}\NormalTok{threat}\OperatorTok{+}\NormalTok{appeal}\OperatorTok{+}\NormalTok{info, }\DataTypeTok{data =}\NormalTok{ delivered)}
\NormalTok{reg_}\DecValTok{24}\NormalTok{ <-}\StringTok{ }\KeywordTok{feols}\NormalTok{(resp_B}\OperatorTok{~}\NormalTok{threat}\OperatorTok{+}\NormalTok{appeal}\OperatorTok{+}\NormalTok{info}\OperatorTok{+}\NormalTok{i_tinf}\OperatorTok{+}\NormalTok{i_tapp, }\DataTypeTok{data =}\NormalTok{ delivered)}
\NormalTok{reg_}\DecValTok{25}\NormalTok{ <-}\StringTok{ }\KeywordTok{feols}\NormalTok{(resp_all}\OperatorTok{~}\NormalTok{threat}\OperatorTok{+}\NormalTok{appeal}\OperatorTok{+}\NormalTok{info, }\DataTypeTok{data =}\NormalTok{ delivered)}
\NormalTok{reg_}\DecValTok{26}\NormalTok{ <-}\StringTok{ }\KeywordTok{feols}\NormalTok{(resp_all}\OperatorTok{~}\NormalTok{threat}\OperatorTok{+}\NormalTok{appeal}\OperatorTok{+}\NormalTok{info}\OperatorTok{+}\NormalTok{i_tinf}\OperatorTok{+}\NormalTok{i_tapp, }\DataTypeTok{data =}\NormalTok{ delivered)}

\CommentTok{#' Dicionário para o nome das variáveis nas tabelas}
\NormalTok{fixest}\OperatorTok{::}\KeywordTok{setFixest_dict}\NormalTok{(}\KeywordTok{c}\NormalTok{(}\DataTypeTok{resp_A =} \StringTok{"Registro"}\NormalTok{, }
                         \DataTypeTok{resp_B =} \StringTok{"Atual. Contratual"}\NormalTok{, }
                         \DataTypeTok{resp_all =} \StringTok{"Resposta Geral"}\NormalTok{,}
                         \DataTypeTok{mailing =} \StringTok{"Correio"}\NormalTok{,}
                         \DataTypeTok{threat =} \StringTok{"Ameaça"}\NormalTok{,}
                         \DataTypeTok{appeal =} \StringTok{"Moral"}\NormalTok{,}
                         \DataTypeTok{info =} \StringTok{"Info"}\NormalTok{,}
                         \DataTypeTok{i_tinf =} \StringTok{"Ameaça x Info"}\NormalTok{,}
                         \DataTypeTok{i_tapp =} \StringTok{"Ameaça x Moral"}\NormalTok{,}
                         \DataTypeTok{threat_evasion_D1 =} \StringTok{"Ameaça x Evasão"}\NormalTok{,}
                         \DataTypeTok{appeal_evasion_D1 =} \StringTok{"Moral x Evasão"}\NormalTok{,}
                         \DataTypeTok{info_evasion_D1 =} \StringTok{"Info x Evasão"}\NormalTok{,}
                         \DataTypeTok{evasion_1 =} \StringTok{"Evasão"}\NormalTok{,}
                         \DataTypeTok{threat_evasion_D2 =} \StringTok{"Ameaça x Evasão"}\NormalTok{,}
                         \DataTypeTok{appeal_evasion_D2 =} \StringTok{"Moral x Evasão"}\NormalTok{,}
                         \DataTypeTok{info_evasion_D2 =} \StringTok{"Info x Evasão"}\NormalTok{,}
                         \DataTypeTok{evasion_2 =} \StringTok{"Evasão"}\NormalTok{,}
                         \StringTok{"(Intercept)"}\NormalTok{ =}\StringTok{ "Constante"}\NormalTok{))}
\CommentTok{#' Ajusta o estilo das tabelas}
\NormalTok{est_style =}\StringTok{ }\KeywordTok{list}\NormalTok{(}\DataTypeTok{depvar =} \StringTok{"title:Dep. Var."}\NormalTok{,}
                 \DataTypeTok{model =} \StringTok{"title:Modelo"}\NormalTok{,}
                 \DataTypeTok{var =} \StringTok{"title:}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{emph\{Variáveis\}"}\NormalTok{,}
                 \DataTypeTok{stats =} \StringTok{"title:}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{emph\{Estatísticas de diagnóstico\}"}\NormalTok{,}
                 \DataTypeTok{notes =} \StringTok{"title:}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{emph\{}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{medskip Notas:\}"}\NormalTok{)}
\CommentTok{#' Cria a Tabela 7. Table 2 in Fellner et. al}
\KeywordTok{esttex}\NormalTok{(reg_}\DecValTok{21}\NormalTok{, reg_}\DecValTok{22}\NormalTok{, reg_}\DecValTok{23}\NormalTok{, reg_}\DecValTok{24}\NormalTok{, reg_}\DecValTok{25}\NormalTok{, reg_}\DecValTok{26}\NormalTok{,}
       \DataTypeTok{file =} \StringTok{"./Tables/table2.tex"}\NormalTok{,}
       \DataTypeTok{label =} \StringTok{"tab:tab2"}\NormalTok{,}
       \DataTypeTok{style =}\NormalTok{ est_style,}
       \DataTypeTok{replace =} \OtherTok{TRUE}\NormalTok{,}
       \DataTypeTok{se =} \StringTok{"White"}\NormalTok{,}
       \DataTypeTok{digits =} \DecValTok{3}\NormalTok{,}
       \DataTypeTok{fitstat =} \StringTok{""}\NormalTok{,}
       \DataTypeTok{order =} \KeywordTok{c}\NormalTok{(}\StringTok{"Correio"}\NormalTok{, }\StringTok{"^Ameaça$"}\NormalTok{, }\StringTok{"^Moral$"}\NormalTok{, }\StringTok{"^Info$"}\NormalTok{, }\StringTok{"Ameaça x Moral"}\NormalTok{,}
                 \StringTok{"Ameaça x Info"}\NormalTok{, }\StringTok{"Constante"}\NormalTok{),}
       \DataTypeTok{title =} \StringTok{"Efeito do tratamento nos registros, atualizações contratuais, and resposta geral para o modelo de regressão linear."}\NormalTok{)}

\CommentTok{#' Efeitos Heterogeneos}
\CommentTok{#' Replicacao da Table C1}
\CommentTok{#' Mediana da população dos municípios, da densidade, da renda e de votantes}
\CommentTok{#' a direita}
\NormalTok{med_pop <-}\StringTok{ }\KeywordTok{median}\NormalTok{(data}\OperatorTok{$}\NormalTok{pop2005, }\DataTypeTok{na.rm =} \OtherTok{TRUE}\NormalTok{)}
\NormalTok{med_den <-}\StringTok{ }\KeywordTok{median}\NormalTok{(data}\OperatorTok{$}\NormalTok{pop_density2005, }\DataTypeTok{na.rm =} \OtherTok{TRUE}\NormalTok{)}
\NormalTok{med_rend <-}\StringTok{ }\KeywordTok{median}\NormalTok{(data}\OperatorTok{$}\NormalTok{inc_aver, }\DataTypeTok{na.rm =} \OtherTok{TRUE}\NormalTok{)}
\NormalTok{med_vot <-}\StringTok{ }\KeywordTok{median}\NormalTok{(data}\OperatorTok{$}\NormalTok{vo_cr }\OperatorTok{+}\StringTok{ }\NormalTok{data}\OperatorTok{$}\NormalTok{vo_r, }\DataTypeTok{na.rm =} \OtherTok{TRUE}\NormalTok{)}
\CommentTok{#' Dataframe com indicadores de acima da mediana}
\NormalTok{efeito_het_df <-}\StringTok{ }\NormalTok{data }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{mutate}\NormalTok{(}\DataTypeTok{pop_hi =}\NormalTok{ pop2005 }\OperatorTok{>=}\StringTok{ }\NormalTok{med_pop,}
         \DataTypeTok{popdens_hi =}\NormalTok{ pop_density2005 }\OperatorTok{>=}\StringTok{ }\NormalTok{med_den,}
         \DataTypeTok{rend_hi =}\NormalTok{ inc_aver }\OperatorTok{>=}\StringTok{ }\NormalTok{med_rend,}
         \DataTypeTok{vot_hi =}\NormalTok{ (vo_cr }\OperatorTok{+}\StringTok{ }\NormalTok{vo_r) }\OperatorTok{>=}\StringTok{ }\NormalTok{med_vot)}
\CommentTok{#' Conjunto de variáveis de controle}
\NormalTok{Z_extended <-}\StringTok{ }\KeywordTok{gsub}\NormalTok{(}\StringTok{"}\CharTok{\textbackslash{}\textbackslash{}}\StringTok{s+"}\NormalTok{, }\StringTok{"+"}\NormalTok{,}
                   \StringTok{"pop_density2005 pop2005 nat_EU nat_nonEU fam_marri fam_divor_widow}
\StringTok{                   edu_hi edu_lo rel_evan rel_isla rel_orth_other rel_obk pers2 pers3 pers4}
\StringTok{                   pers5more  vo_r vo_cl vo_l  j_unempl j_retire j_house j_studen}
\StringTok{                   inc_aver age0_30 age30_60  bgld kaern noe ooe salzbg steierm }
\StringTok{                   tirol vlbg wien schober"}\NormalTok{)}
\CommentTok{#' Regressões para efeitos heterogêneos}
\CommentTok{#' formulas}
\NormalTok{form_str <-}\StringTok{ }\KeywordTok{paste0}\NormalTok{(}\StringTok{"resp_A~threat+appeal+info+gender+compliance_t+"}\NormalTok{, Z_extended)}
\CommentTok{#' Default do erro padrão é ser robusto a heterocedasticidade}
\NormalTok{fixest}\OperatorTok{::}\KeywordTok{setFixest_se}\NormalTok{(}\DataTypeTok{no_FE =} \StringTok{"white"}\NormalTok{)}
\NormalTok{het_reg_pop <-}\StringTok{ }\NormalTok{efeito_het_df }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(delivered }\OperatorTok{==}\StringTok{ }\DecValTok{1}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{group_by}\NormalTok{(pop_hi) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{summarise}\NormalTok{(}\DataTypeTok{lm_model =} \KeywordTok{list}\NormalTok{(}\KeywordTok{feols}\NormalTok{(}\KeywordTok{as.formula}\NormalTok{(form_str), }\DataTypeTok{data =} \KeywordTok{cur_data}\NormalTok{())))}

\NormalTok{het_reg_den <-}\StringTok{ }\NormalTok{efeito_het_df }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(delivered }\OperatorTok{==}\StringTok{ }\DecValTok{1}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{group_by}\NormalTok{(popdens_hi) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{summarise}\NormalTok{(}\DataTypeTok{lm_model =} \KeywordTok{list}\NormalTok{(}\KeywordTok{feols}\NormalTok{(}\KeywordTok{as.formula}\NormalTok{(form_str), }\DataTypeTok{data =} \KeywordTok{cur_data}\NormalTok{())))}

\NormalTok{het_reg_rend <-}\StringTok{ }\NormalTok{efeito_het_df }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(delivered }\OperatorTok{==}\StringTok{ }\DecValTok{1}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{group_by}\NormalTok{(rend_hi) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{summarise}\NormalTok{(}\DataTypeTok{lm_model =} \KeywordTok{list}\NormalTok{(}\KeywordTok{feols}\NormalTok{(}\KeywordTok{as.formula}\NormalTok{(form_str), }\DataTypeTok{data =} \KeywordTok{cur_data}\NormalTok{())))}

\NormalTok{het_reg_vot <-}\StringTok{ }\NormalTok{efeito_het_df }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{filter}\NormalTok{(delivered }\OperatorTok{==}\StringTok{ }\DecValTok{1}\NormalTok{) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{group_by}\NormalTok{(vot_hi) }\OperatorTok{%>%}\StringTok{ }
\StringTok{  }\KeywordTok{summarise}\NormalTok{(}\DataTypeTok{lm_model =} \KeywordTok{list}\NormalTok{(}\KeywordTok{feols}\NormalTok{(}\KeywordTok{as.formula}\NormalTok{(form_str), }\DataTypeTok{data =} \KeywordTok{cur_data}\NormalTok{())))}

\CommentTok{#' Tabela 8}
\KeywordTok{esttex}\NormalTok{(het_reg_pop}\OperatorTok{$}\NormalTok{lm_model, het_reg_den}\OperatorTok{$}\NormalTok{lm_model, het_reg_rend}\OperatorTok{$}\NormalTok{lm_model, }
\NormalTok{       het_reg_vot}\OperatorTok{$}\NormalTok{lm_model,}
       \DataTypeTok{file =} \StringTok{"./Tables/tablec1.tex"}\NormalTok{,}
       \DataTypeTok{label =} \StringTok{"tab:tabc1"}\NormalTok{,}
       \DataTypeTok{style =}\NormalTok{ est_style,}
       \DataTypeTok{replace =} \OtherTok{TRUE}\NormalTok{,}
       \DataTypeTok{se =} \StringTok{"White"}\NormalTok{,}
       \DataTypeTok{digits =} \DecValTok{3}\NormalTok{,}
       \DataTypeTok{fitstat =} \StringTok{""}\NormalTok{,}
       \DataTypeTok{keep =} \KeywordTok{c}\NormalTok{(}\StringTok{"^Ameaça$"}\NormalTok{, }\StringTok{"^Moral$"}\NormalTok{, }\StringTok{"^Info$"}\NormalTok{),}
       \DataTypeTok{order =} \KeywordTok{c}\NormalTok{(}\StringTok{"^Ameaça$"}\NormalTok{, }\StringTok{"^Moral$"}\NormalTok{, }\StringTok{"^Info$"}\NormalTok{),}
       \DataTypeTok{title =} \StringTok{"Efeito heterogêneo do tratamento. Modelo de regressão linear."}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Metodos de Machine Learning para inferencia causal}
\CommentTok{# com dados de Fellner et all (2013)}
\CommentTok{# Autor: Rafael Felipe Bressan}
\CommentTok{# Arquivo: script_py.py}
\CommentTok{# Script Python para o trabalho monografico: Inferência Causal com Machine }
\CommentTok{# Learning uma aplicacao para evasao fiscal}
\CommentTok{# Pós-Graduacao Lato Sensu em Ciencia de Dados e Big Data PUC-MG}
\CommentTok{# Ano: 2021}

\CommentTok{# importa bibliotecas necessarias}
\ImportTok{import}\NormalTok{ gc}
\ImportTok{from}\NormalTok{ copy }\ImportTok{import}\NormalTok{ deepcopy}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd }

\CommentTok{# Regressao linear e IV}
\ImportTok{import}\NormalTok{ statsmodels.api }\ImportTok{as}\NormalTok{ sm}
\ImportTok{from}\NormalTok{ linearmodels }\ImportTok{import}\NormalTok{ IV2SLS}

\CommentTok{# Modelos de ML}
\ImportTok{import}\NormalTok{ lightgbm }\ImportTok{as}\NormalTok{ lgb }
\ImportTok{from}\NormalTok{ sklearn.preprocessing }\ImportTok{import}\NormalTok{ PolynomialFeatures}
\ImportTok{from}\NormalTok{ sklearn.linear_model }\ImportTok{import}\NormalTok{ LogisticRegression, Lasso}
\ImportTok{from}\NormalTok{ sklearn.ensemble }\ImportTok{import}\NormalTok{ RandomForestRegressor}

\CommentTok{# EconML}
\ImportTok{from}\NormalTok{ econml.ortho_iv }\ImportTok{import}\NormalTok{ DMLATEIV, IntentToTreatDRIV}
\ImportTok{from}\NormalTok{ econml.cate_interpreter }\ImportTok{import}\NormalTok{ SingleTreeCateInterpreter}
\ImportTok{from}\NormalTok{ econml.dml }\ImportTok{import}\NormalTok{ ForestDML, DML, SparseLinearDML}
\ImportTok{from}\NormalTok{ econml.causal_forest }\ImportTok{import}\NormalTok{ CausalForest}

\CommentTok{# Graficos}
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}

\CommentTok{# Funcoes auxiliares}
\KeywordTok{def}\NormalTok{ stars(x, levels}\OperatorTok{=}\NormalTok{[}\FloatTok{0.1}\NormalTok{, }\FloatTok{0.05}\NormalTok{, }\FloatTok{0.01}\NormalTok{]):}
    \ControlFlowTok{assert}\NormalTok{ (}\BuiltInTok{len}\NormalTok{(levels)}\OperatorTok{==}\DecValTok{3}\NormalTok{), }\StringTok{"Comprimento de levels deve ser 3."}
    
    \ControlFlowTok{if}\NormalTok{ x}\OperatorTok{>}\NormalTok{levels[}\DecValTok{0}\NormalTok{]:}
        \ControlFlowTok{return} \StringTok{''}
    \ControlFlowTok{elif}\NormalTok{ x}\OperatorTok{>}\NormalTok{levels[}\DecValTok{1}\NormalTok{]:}
        \ControlFlowTok{return} \StringTok{'*'}
    \ControlFlowTok{elif}\NormalTok{ x}\OperatorTok{>}\NormalTok{levels[}\DecValTok{2}\NormalTok{]:}
        \ControlFlowTok{return} \StringTok{'**'}
    \ControlFlowTok{else}\NormalTok{:}
        \ControlFlowTok{return} \StringTok{'***'}

\KeywordTok{def}\NormalTok{ format_float(x, digits):}
    \ControlFlowTok{return} \StringTok{'\{:.}\SpecialCharTok{\{dig\}}\StringTok{f\}'}\NormalTok{.}\BuiltInTok{format}\NormalTok{(x, dig}\OperatorTok{=}\NormalTok{digits)}

\KeywordTok{def}\NormalTok{ surr_parenthesis(x, digits):}
    \ControlFlowTok{return} \StringTok{'('}\OperatorTok{+}\StringTok{'\{:.}\SpecialCharTok{\{dig\}}\StringTok{f\}'}\NormalTok{.}\BuiltInTok{format}\NormalTok{(x, dig}\OperatorTok{=}\NormalTok{digits)}\OperatorTok{+}\StringTok{')'}


\CommentTok{# Carregando os dados}
\NormalTok{data }\OperatorTok{=}\NormalTok{ pd.read_stata(}\StringTok{"data_final.dta"}\NormalTok{).sort_values(}\StringTok{"treatment"}\NormalTok{)}
\NormalTok{X_cols }\OperatorTok{=}\NormalTok{ [}\StringTok{"gender"}\NormalTok{, }\StringTok{"pop_density2005"}\NormalTok{, }
    \StringTok{"compliance"}\NormalTok{, }\StringTok{"compliance_t"}\NormalTok{, }\StringTok{"vo_r"}\NormalTok{, }\StringTok{"vo_cr"}\NormalTok{, }\StringTok{"vo_cl"}\NormalTok{, }\StringTok{"vo_l"}\NormalTok{, }
    \StringTok{"inc_aver"}\NormalTok{, }\StringTok{"edu_aver"}\NormalTok{, }\StringTok{"edu_lo"}\NormalTok{, }\StringTok{"edu_mi"}\NormalTok{, }\StringTok{"edu_hi"}\NormalTok{, }
    \StringTok{"age_aver"}\NormalTok{, }\StringTok{"age0_30"}\NormalTok{, }\StringTok{"age30_60"}\NormalTok{, }\StringTok{"nat_A"}\NormalTok{, }\StringTok{"nat_EU"}\NormalTok{, }\StringTok{"nat_nonEU"}\NormalTok{]}
    
\CommentTok{################################################################}
\CommentTok{# Ignorando o atrito e estimando os efeitos apenas para }
\CommentTok{# delivered == 1}
\CommentTok{################################################################}
\NormalTok{deliv }\OperatorTok{=}\NormalTok{ data[data[}\StringTok{"delivered"}\NormalTok{]}\OperatorTok{!=}\DecValTok{0}\NormalTok{].fillna(}\DecValTok{0}\NormalTok{)}
\CommentTok{# Para avaliacao de efeitos heterogeneos}
\NormalTok{X_eval }\OperatorTok{=}\NormalTok{ (deliv[X_cols]}
\NormalTok{    .describe()}
\NormalTok{    .loc[[}\StringTok{"mean"}\NormalTok{, }\StringTok{"min"}\NormalTok{, }\StringTok{"25%"}\NormalTok{, }\StringTok{"50%"}\NormalTok{, }\StringTok{"75%"}\NormalTok{, }\StringTok{"max"}\NormalTok{]]}
\NormalTok{)}
\CommentTok{# Tratamentos}
\NormalTok{t1_deliv }\OperatorTok{=}\NormalTok{ deliv[deliv[}\StringTok{"treatment"}\NormalTok{].isin([}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{])]}
\NormalTok{t2_deliv }\OperatorTok{=}\NormalTok{ deliv[deliv[}\StringTok{"treatment"}\NormalTok{].isin([}\DecValTok{0}\NormalTok{,}\DecValTok{2}\NormalTok{])]}
\NormalTok{t3_deliv }\OperatorTok{=}\NormalTok{ deliv[deliv[}\StringTok{"treatment"}\NormalTok{].isin([}\DecValTok{0}\NormalTok{,}\DecValTok{3}\NormalTok{])]}
\NormalTok{t5_deliv }\OperatorTok{=}\NormalTok{ deliv[deliv[}\StringTok{"treatment"}\NormalTok{].isin([}\DecValTok{0}\NormalTok{,}\DecValTok{5}\NormalTok{])]}

\CommentTok{# Variaveis de interesse}
\NormalTok{Y1 }\OperatorTok{=}\NormalTok{ t1_deliv[}\StringTok{"resp_A"}\NormalTok{].values}
\NormalTok{T1 }\OperatorTok{=}\NormalTok{ t1_deliv[}\StringTok{"delivered"}\NormalTok{].values}
\NormalTok{X1 }\OperatorTok{=}\NormalTok{ t1_deliv[X_cols].values}
\NormalTok{X1_treat}\OperatorTok{=}\NormalTok{X1[T1 }\OperatorTok{==} \DecValTok{1}\NormalTok{]}

\NormalTok{Y2 }\OperatorTok{=}\NormalTok{ t2_deliv[}\StringTok{"resp_A"}\NormalTok{].values}
\NormalTok{T2 }\OperatorTok{=}\NormalTok{ t2_deliv[}\StringTok{"delivered"}\NormalTok{].values}
\NormalTok{X2 }\OperatorTok{=}\NormalTok{ t2_deliv[X_cols].values}
\NormalTok{X2_treat}\OperatorTok{=}\NormalTok{X2[T2 }\OperatorTok{==} \DecValTok{1}\NormalTok{]}

\NormalTok{Y3 }\OperatorTok{=}\NormalTok{ t3_deliv[}\StringTok{"resp_A"}\NormalTok{].values}
\NormalTok{T3 }\OperatorTok{=}\NormalTok{ t3_deliv[}\StringTok{"delivered"}\NormalTok{].values}
\NormalTok{X3 }\OperatorTok{=}\NormalTok{ t3_deliv[X_cols].values}
\NormalTok{X3_treat}\OperatorTok{=}\NormalTok{X3[T3 }\OperatorTok{==} \DecValTok{1}\NormalTok{]}

\NormalTok{Y5 }\OperatorTok{=}\NormalTok{ t5_deliv[}\StringTok{"resp_A"}\NormalTok{].values}
\NormalTok{T5 }\OperatorTok{=}\NormalTok{ t5_deliv[}\StringTok{"delivered"}\NormalTok{].values}
\NormalTok{X5 }\OperatorTok{=}\NormalTok{ t5_deliv[X_cols].values}
\NormalTok{X5_treat}\OperatorTok{=}\NormalTok{X5[T5 }\OperatorTok{==} \DecValTok{1}\NormalTok{]}

\CommentTok{# ForestDML() = CausalForest()??}
\CommentTok{# ForestDML eh muito mais rapido que CausalForest com resultados }
\CommentTok{# semelhantes para a interpretacao via arvore}

\CommentTok{# DML com regressao logistica para E[T|X,W] e Floresta Aleatoria para}
\CommentTok{# E[Y|X,W]. Modelo final para Theta(X) eh escolhido por floresta}
\NormalTok{dml}\OperatorTok{=}\NormalTok{ForestDML(}
\NormalTok{    model_t}\OperatorTok{=}\NormalTok{LogisticRegression(),}
\NormalTok{    model_y}\OperatorTok{=}\NormalTok{RandomForestRegressor(),}
\NormalTok{    discrete_treatment}\OperatorTok{=}\VariableTok{True}\NormalTok{,}
\NormalTok{    n_estimators}\OperatorTok{=}\DecValTok{1000}\NormalTok{,}
\NormalTok{    subsample_fr}\OperatorTok{=}\FloatTok{0.7}\NormalTok{,}
\NormalTok{    min_samples_leaf}\OperatorTok{=}\DecValTok{20}\NormalTok{,}
\NormalTok{    n_crossfit_splits}\OperatorTok{=}\DecValTok{3}\NormalTok{,}
\NormalTok{    n_jobs}\OperatorTok{=-}\DecValTok{1}
\NormalTok{)}
\CommentTok{# DML para T1}
\NormalTok{dml.fit(Y1, T1, X1, inference}\OperatorTok{=}\StringTok{'auto'}\NormalTok{)}
\NormalTok{dml1_eff}\OperatorTok{=}\NormalTok{dml.effect(X1, T0}\OperatorTok{=}\DecValTok{0}\NormalTok{, T1}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
\NormalTok{dml1_eff_treat}\OperatorTok{=}\NormalTok{dml.effect(X1_treat, T0}\OperatorTok{=}\DecValTok{0}\NormalTok{, T1}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"ATE T1 por DML: }\SpecialCharTok{\{np.}\NormalTok{mean(dml1_eff)}\SpecialCharTok{\}}\CharTok{\textbackslash{}n}\SpecialStringTok{ATT T1 por DML: }\SpecialCharTok{\{np.}\NormalTok{mean(dml1_eff_treat)}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{)}
\NormalTok{dml1_inf}\OperatorTok{=}\NormalTok{dml.effect_inference(X_eval.values)}
\NormalTok{dml1_summary}\OperatorTok{=}\NormalTok{dml1_inf.summary_frame(alpha}\OperatorTok{=}\FloatTok{0.05}\NormalTok{)[[}\StringTok{"point_estimate"}\NormalTok{, }\StringTok{"pvalue"}\NormalTok{, }\StringTok{"stderr"}\NormalTok{]]}
\NormalTok{dml1_summary.index}\OperatorTok{=}\NormalTok{X_eval.index}
\NormalTok{dml1_summary[}\StringTok{"star"}\NormalTok{]}\OperatorTok{=}\NormalTok{dml1_summary[}\StringTok{"pvalue"}\NormalTok{].}\BuiltInTok{apply}\NormalTok{(stars)}
\NormalTok{dml1_summary[}\StringTok{"point_estimate"}\NormalTok{]}\OperatorTok{=}\NormalTok{dml1_summary[}\StringTok{"point_estimate"}\NormalTok{].}\BuiltInTok{apply}\NormalTok{(format_float, digits}\OperatorTok{=}\DecValTok{4}\NormalTok{)}
\NormalTok{dml1_summary[}\StringTok{"point_estimate"}\NormalTok{]}\OperatorTok{=}\NormalTok{dml1_summary[}\StringTok{"point_estimate"}\NormalTok{].}\BuiltInTok{str}\NormalTok{.cat(dml1_summary[}\StringTok{"star"}\NormalTok{])}
\NormalTok{dml1_summary[}\StringTok{"stderr"}\NormalTok{]}\OperatorTok{=}\NormalTok{dml1_summary[}\StringTok{"stderr"}\NormalTok{].}\BuiltInTok{apply}\NormalTok{(surr_parenthesis, digits}\OperatorTok{=}\DecValTok{4}\NormalTok{)}
\NormalTok{dml1_summary}\OperatorTok{=}\NormalTok{dml1_summary[[}\StringTok{"point_estimate"}\NormalTok{, }\StringTok{"stderr"}\NormalTok{]].stack()}
\NormalTok{dml1_summary.name}\OperatorTok{=}\StringTok{"Correio"}

\CommentTok{# DML para T2}
\NormalTok{dml.fit(Y2, T2, X2, inference}\OperatorTok{=}\StringTok{'auto'}\NormalTok{)}
\NormalTok{dml2_eff}\OperatorTok{=}\NormalTok{dml.effect(X2, T0}\OperatorTok{=}\DecValTok{0}\NormalTok{, T1}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
\NormalTok{dml2_eff_treat}\OperatorTok{=}\NormalTok{dml.effect(X2_treat, T0}\OperatorTok{=}\DecValTok{0}\NormalTok{, T1}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"ATE T2 por DML: }\SpecialCharTok{\{np.}\NormalTok{mean(dml2_eff)}\SpecialCharTok{\}}\CharTok{\textbackslash{}n}\SpecialStringTok{ATT T2 por DML: }\SpecialCharTok{\{np.}\NormalTok{mean(dml2_eff_treat)}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{)}
\NormalTok{dml2_inf}\OperatorTok{=}\NormalTok{dml.effect_inference(X_eval.values)}
\NormalTok{dml2_summary}\OperatorTok{=}\NormalTok{dml2_inf.summary_frame(alpha}\OperatorTok{=}\FloatTok{0.05}\NormalTok{)[[}\StringTok{"point_estimate"}\NormalTok{, }\StringTok{"pvalue"}\NormalTok{, }\StringTok{"stderr"}\NormalTok{]]}
\NormalTok{dml2_summary.index}\OperatorTok{=}\NormalTok{X_eval.index}
\NormalTok{dml2_summary[}\StringTok{"star"}\NormalTok{]}\OperatorTok{=}\NormalTok{dml2_summary[}\StringTok{"pvalue"}\NormalTok{].}\BuiltInTok{apply}\NormalTok{(stars)}
\NormalTok{dml2_summary[}\StringTok{"point_estimate"}\NormalTok{]}\OperatorTok{=}\NormalTok{dml2_summary[}\StringTok{"point_estimate"}\NormalTok{].}\BuiltInTok{apply}\NormalTok{(format_float, digits}\OperatorTok{=}\DecValTok{4}\NormalTok{)}
\NormalTok{dml2_summary[}\StringTok{"point_estimate"}\NormalTok{]}\OperatorTok{=}\NormalTok{dml2_summary[}\StringTok{"point_estimate"}\NormalTok{].}\BuiltInTok{str}\NormalTok{.cat(dml2_summary[}\StringTok{"star"}\NormalTok{])}
\NormalTok{dml2_summary[}\StringTok{"stderr"}\NormalTok{]}\OperatorTok{=}\NormalTok{dml2_summary[}\StringTok{"stderr"}\NormalTok{].}\BuiltInTok{apply}\NormalTok{(surr_parenthesis, digits}\OperatorTok{=}\DecValTok{4}\NormalTok{)}
\NormalTok{dml2_summary}\OperatorTok{=}\NormalTok{dml2_summary[[}\StringTok{"point_estimate"}\NormalTok{, }\StringTok{"stderr"}\NormalTok{]].stack()}
\NormalTok{dml2_summary.name}\OperatorTok{=}\StringTok{"Ameaça"}

\CommentTok{# Interpretacao por arvore de decisao para T2}
\NormalTok{interp }\OperatorTok{=}\NormalTok{ SingleTreeCateInterpreter(}
\NormalTok{    include_model_uncertainty}\OperatorTok{=}\VariableTok{False}\NormalTok{, }
\NormalTok{    max_depth}\OperatorTok{=}\DecValTok{3}\NormalTok{, }
\NormalTok{    min_samples_leaf}\OperatorTok{=}\DecValTok{10}\NormalTok{)}
\NormalTok{interp.interpret(dml, X2)}
\NormalTok{fig, ax1 }\OperatorTok{=}\NormalTok{ plt.subplots(figsize}\OperatorTok{=}\NormalTok{(}\DecValTok{25}\NormalTok{,}\DecValTok{6}\NormalTok{))}
\NormalTok{interp.plot(feature_names}\OperatorTok{=}\NormalTok{X_cols, fontsize}\OperatorTok{=}\DecValTok{12}\NormalTok{, ax}\OperatorTok{=}\NormalTok{ax1)}
\NormalTok{fig.savefig(}\StringTok{"Figs/fig_tree_dml.png"}\NormalTok{)}

\CommentTok{# DML para T3}
\NormalTok{dml.fit(Y3, T3, X3, inference}\OperatorTok{=}\StringTok{'auto'}\NormalTok{)}
\NormalTok{dml3_eff}\OperatorTok{=}\NormalTok{dml.effect(X3, T0}\OperatorTok{=}\DecValTok{0}\NormalTok{, T1}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
\NormalTok{dml3_eff_treat}\OperatorTok{=}\NormalTok{dml.effect(X3_treat, T0}\OperatorTok{=}\DecValTok{0}\NormalTok{, T1}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"ATE T3 por DML: }\SpecialCharTok{\{np.}\NormalTok{mean(dml3_eff)}\SpecialCharTok{\}}\CharTok{\textbackslash{}n}\SpecialStringTok{ATT T3 por DML: }\SpecialCharTok{\{np.}\NormalTok{mean(dml3_eff_treat)}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{)}
\NormalTok{dml3_inf}\OperatorTok{=}\NormalTok{dml.effect_inference(X_eval.values)}
\NormalTok{dml3_summary}\OperatorTok{=}\NormalTok{dml3_inf.summary_frame(alpha}\OperatorTok{=}\FloatTok{0.05}\NormalTok{)[[}\StringTok{"point_estimate"}\NormalTok{, }\StringTok{"pvalue"}\NormalTok{, }\StringTok{"stderr"}\NormalTok{]]}
\NormalTok{dml3_summary.index}\OperatorTok{=}\NormalTok{X_eval.index}
\NormalTok{dml3_summary[}\StringTok{"star"}\NormalTok{]}\OperatorTok{=}\NormalTok{dml3_summary[}\StringTok{"pvalue"}\NormalTok{].}\BuiltInTok{apply}\NormalTok{(stars)}
\NormalTok{dml3_summary[}\StringTok{"point_estimate"}\NormalTok{]}\OperatorTok{=}\NormalTok{dml3_summary[}\StringTok{"point_estimate"}\NormalTok{].}\BuiltInTok{apply}\NormalTok{(format_float, digits}\OperatorTok{=}\DecValTok{4}\NormalTok{)}
\NormalTok{dml3_summary[}\StringTok{"point_estimate"}\NormalTok{]}\OperatorTok{=}\NormalTok{dml3_summary[}\StringTok{"point_estimate"}\NormalTok{].}\BuiltInTok{str}\NormalTok{.cat(dml3_summary[}\StringTok{"star"}\NormalTok{])}
\NormalTok{dml3_summary[}\StringTok{"stderr"}\NormalTok{]}\OperatorTok{=}\NormalTok{dml3_summary[}\StringTok{"stderr"}\NormalTok{].}\BuiltInTok{apply}\NormalTok{(surr_parenthesis, digits}\OperatorTok{=}\DecValTok{4}\NormalTok{)}
\NormalTok{dml3_summary}\OperatorTok{=}\NormalTok{dml3_summary[[}\StringTok{"point_estimate"}\NormalTok{, }\StringTok{"stderr"}\NormalTok{]].stack()}
\NormalTok{dml3_summary.name}\OperatorTok{=}\StringTok{"Info"}

\CommentTok{# DML para T5}
\NormalTok{dml.fit(Y5, T5, X5, inference}\OperatorTok{=}\StringTok{'auto'}\NormalTok{)}
\NormalTok{dml5_eff}\OperatorTok{=}\NormalTok{dml.effect(X5, T0}\OperatorTok{=}\DecValTok{0}\NormalTok{, T1}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
\NormalTok{dml5_eff_treat}\OperatorTok{=}\NormalTok{dml.effect(X5_treat, T0}\OperatorTok{=}\DecValTok{0}\NormalTok{, T1}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"ATE T5 por DML: }\SpecialCharTok{\{np.}\NormalTok{mean(dml5_eff)}\SpecialCharTok{\}}\CharTok{\textbackslash{}n}\SpecialStringTok{ATT T5 por DML: }\SpecialCharTok{\{np.}\NormalTok{mean(dml5_eff_treat)}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{)}
\NormalTok{dml5_inf}\OperatorTok{=}\NormalTok{dml.effect_inference(X_eval.values)}
\NormalTok{dml5_summary}\OperatorTok{=}\NormalTok{dml5_inf.summary_frame(alpha}\OperatorTok{=}\FloatTok{0.05}\NormalTok{)[[}\StringTok{"point_estimate"}\NormalTok{, }\StringTok{"pvalue"}\NormalTok{, }\StringTok{"stderr"}\NormalTok{]]}
\NormalTok{dml5_summary.index}\OperatorTok{=}\NormalTok{X_eval.index}
\NormalTok{dml5_summary[}\StringTok{"star"}\NormalTok{]}\OperatorTok{=}\NormalTok{dml5_summary[}\StringTok{"pvalue"}\NormalTok{].}\BuiltInTok{apply}\NormalTok{(stars)}
\NormalTok{dml5_summary[}\StringTok{"point_estimate"}\NormalTok{]}\OperatorTok{=}\NormalTok{dml5_summary[}\StringTok{"point_estimate"}\NormalTok{].}\BuiltInTok{apply}\NormalTok{(format_float, digits}\OperatorTok{=}\DecValTok{4}\NormalTok{)}
\NormalTok{dml5_summary[}\StringTok{"point_estimate"}\NormalTok{]}\OperatorTok{=}\NormalTok{dml5_summary[}\StringTok{"point_estimate"}\NormalTok{].}\BuiltInTok{str}\NormalTok{.cat(dml5_summary[}\StringTok{"star"}\NormalTok{])}
\NormalTok{dml5_summary[}\StringTok{"stderr"}\NormalTok{]}\OperatorTok{=}\NormalTok{dml5_summary[}\StringTok{"stderr"}\NormalTok{].}\BuiltInTok{apply}\NormalTok{(surr_parenthesis, digits}\OperatorTok{=}\DecValTok{4}\NormalTok{)}
\NormalTok{dml5_summary}\OperatorTok{=}\NormalTok{dml5_summary[[}\StringTok{"point_estimate"}\NormalTok{, }\StringTok{"stderr"}\NormalTok{]].stack()}
\NormalTok{dml5_summary.name}\OperatorTok{=}\StringTok{"Moral"}

\CommentTok{# Melhora consumo de memoria}
\KeywordTok{del}\NormalTok{ dml}
\NormalTok{collected}\OperatorTok{=}\NormalTok{gc.collect()}
\CommentTok{# ATE}
\NormalTok{dml_ate}\OperatorTok{=}\NormalTok{[np.mean(x) }\ControlFlowTok{for}\NormalTok{ x }\KeywordTok{in}\NormalTok{ [dml1_eff, dml2_eff, dml3_eff, dml5_eff]]}
\CommentTok{# ATT}
\NormalTok{dml_att}\OperatorTok{=}\NormalTok{[np.mean(x) }\ControlFlowTok{for}\NormalTok{ x }\KeywordTok{in} 
\NormalTok{    [dml1_eff_treat, dml2_eff_treat, dml3_eff_treat, dml5_eff_treat]]}

\NormalTok{treatments_list}\OperatorTok{=}\NormalTok{[}\StringTok{"Correio"}\NormalTok{, }\StringTok{"Ameaça"}\NormalTok{, }\StringTok{"Info"}\NormalTok{, }\StringTok{"Moral"}\NormalTok{]}
\NormalTok{dml_effect}\OperatorTok{=}\NormalTok{pd.DataFrame(\{}\StringTok{"ATE"}\NormalTok{: dml_ate, }\StringTok{"ATT"}\NormalTok{: dml_att\}, index}\OperatorTok{=}\NormalTok{treatments_list)}

\CommentTok{# Quantis das variaveis utilizadas para aferir heterogeneidade}
\NormalTok{X_eval.transpose().to_latex(}
\NormalTok{    buf}\OperatorTok{=}\StringTok{"Tables/tab_het_vars.tex"}\NormalTok{,}
\NormalTok{    decimal}\OperatorTok{=}\StringTok{","}\NormalTok{,}
\NormalTok{    caption}\OperatorTok{=}\StringTok{"Variáveis utilizadas para identificar heterogeneidade nos efeitos."}\NormalTok{,}
\NormalTok{    label}\OperatorTok{=}\StringTok{"tab:het-vars"}
\NormalTok{)}

\CommentTok{# Sumario com os resultados para os 4 tratamentos}
\NormalTok{dml_summary}\OperatorTok{=}\NormalTok{(}
\NormalTok{    pd.concat(}
\NormalTok{        [dml1_summary, dml2_summary, dml3_summary, dml5_summary],}
\NormalTok{        axis}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
\NormalTok{    .reset_index()}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{\{}\StringTok{"level_0"}\NormalTok{: }\StringTok{"X"}\NormalTok{\})}
\NormalTok{    .drop(columns}\OperatorTok{=}\StringTok{"level_1"}\NormalTok{)}
\NormalTok{)}

\NormalTok{dml_summary.to_latex(}
\NormalTok{    buf}\OperatorTok{=}\StringTok{"Tables/tab_dml_summary.tex"}\NormalTok{,}
\NormalTok{    decimal}\OperatorTok{=}\StringTok{","}\NormalTok{,}
\NormalTok{    caption}\OperatorTok{=}\StringTok{"Efeitos heterogêneos do tratamento estimados por Double Machine Learning."}\NormalTok{,}
\NormalTok{    label}\OperatorTok{=}\StringTok{"tab:dml-summary"}\NormalTok{,}
\NormalTok{    index}\OperatorTok{=}\VariableTok{False}
\NormalTok{)}
\CommentTok{# Nota: os estágios de previsão foram floresta aleatória para $E[Y|\textbackslash{}bfx]$}
\CommentTok{# e regressão logística para $E[T|\textbackslash{}bfx]$. O modelo final para o efeito }
\CommentTok{# condicional do tratamento, $\textbackslash{}theta(\textbackslash{}bfx)$, é uma floresta aleatória.}

\CommentTok{################################################################}
\CommentTok{# Metodos com variaveis Instrumentais}
\CommentTok{################################################################}

\CommentTok{################################################################}
\CommentTok{# Considerando o atrito e estimando os efeitos }
\CommentTok{################################################################}
\NormalTok{iv}\OperatorTok{=}\NormalTok{data.copy()}
\NormalTok{iv[}\StringTok{"delivered"}\NormalTok{] }\OperatorTok{=}\NormalTok{ iv[}\StringTok{"delivered"}\NormalTok{].fillna(}\DecValTok{0}\NormalTok{)}
\CommentTok{# Para avaliacao de heterogeneidade}
\NormalTok{X_eval }\OperatorTok{=}\NormalTok{ (iv[X_cols]}
\NormalTok{    .describe()}
\NormalTok{    .loc[[}\StringTok{"mean"}\NormalTok{, }\StringTok{"min"}\NormalTok{, }\StringTok{"25%"}\NormalTok{, }\StringTok{"50%"}\NormalTok{, }\StringTok{"75%"}\NormalTok{, }\StringTok{"max"}\NormalTok{]]}
\NormalTok{)}
\CommentTok{# Tratamentos}
\NormalTok{t1_iv }\OperatorTok{=}\NormalTok{ iv[iv[}\StringTok{"treatment"}\NormalTok{].isin([}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{])]}
\NormalTok{t2_iv }\OperatorTok{=}\NormalTok{ iv[iv[}\StringTok{"treatment"}\NormalTok{].isin([}\DecValTok{0}\NormalTok{,}\DecValTok{2}\NormalTok{])]}
\NormalTok{t3_iv }\OperatorTok{=}\NormalTok{ iv[iv[}\StringTok{"treatment"}\NormalTok{].isin([}\DecValTok{0}\NormalTok{,}\DecValTok{3}\NormalTok{])]}
\NormalTok{t5_iv }\OperatorTok{=}\NormalTok{ iv[iv[}\StringTok{"treatment"}\NormalTok{].isin([}\DecValTok{0}\NormalTok{,}\DecValTok{5}\NormalTok{])]}

\CommentTok{# Definindo as variaveis}
\NormalTok{Z1 }\OperatorTok{=}\NormalTok{ t1_iv[}\StringTok{"treatment"}\NormalTok{]}
\NormalTok{T1 }\OperatorTok{=}\NormalTok{ t1_iv[}\StringTok{"delivered"}\NormalTok{]}
\NormalTok{Y1 }\OperatorTok{=}\NormalTok{ t1_iv[}\StringTok{"resp_A"}\NormalTok{]}
\NormalTok{X1 }\OperatorTok{=}\NormalTok{ t1_iv[X_cols]}

\NormalTok{Z2 }\OperatorTok{=}\NormalTok{ t2_iv[}\StringTok{"treatment"}\NormalTok{]}
\NormalTok{T2 }\OperatorTok{=}\NormalTok{ t2_iv[}\StringTok{"delivered"}\NormalTok{]}
\NormalTok{Y2 }\OperatorTok{=}\NormalTok{ t2_iv[}\StringTok{"resp_A"}\NormalTok{]}
\NormalTok{X2 }\OperatorTok{=}\NormalTok{ t2_iv[X_cols]}

\NormalTok{Z3 }\OperatorTok{=}\NormalTok{ t3_iv[}\StringTok{"treatment"}\NormalTok{]}
\NormalTok{T3 }\OperatorTok{=}\NormalTok{ t3_iv[}\StringTok{"delivered"}\NormalTok{]}
\NormalTok{Y3 }\OperatorTok{=}\NormalTok{ t3_iv[}\StringTok{"resp_A"}\NormalTok{]}
\NormalTok{X3 }\OperatorTok{=}\NormalTok{ t3_iv[X_cols]}

\NormalTok{Z5 }\OperatorTok{=}\NormalTok{ t5_iv[}\StringTok{"treatment"}\NormalTok{]}
\NormalTok{T5 }\OperatorTok{=}\NormalTok{ t5_iv[}\StringTok{"delivered"}\NormalTok{]}
\NormalTok{Y5 }\OperatorTok{=}\NormalTok{ t5_iv[}\StringTok{"resp_A"}\NormalTok{]}
\NormalTok{X5 }\OperatorTok{=}\NormalTok{ t5_iv[X_cols]}

\CommentTok{# Modelos para E[Y|X] e E[T|Z,X]}
\NormalTok{lgb_YX_par }\OperatorTok{=}\NormalTok{ \{}
    \StringTok{"metric"}\NormalTok{: }\StringTok{"rmse"}\NormalTok{,}
    \StringTok{"learning_rate"}\NormalTok{: }\FloatTok{0.1}\NormalTok{,}
    \StringTok{"num_leaves"}\NormalTok{: }\DecValTok{30}\NormalTok{,}
    \StringTok{"max_depth"}\NormalTok{: }\DecValTok{5}
\NormalTok{\}}

\NormalTok{lgb_TXZ_par }\OperatorTok{=}\NormalTok{ \{}
    \StringTok{"objective"}\NormalTok{: }\StringTok{"binary"}\NormalTok{,}
    \StringTok{"metric"}\NormalTok{: }\StringTok{"auc"}\NormalTok{,}
    \StringTok{"learning_rate"}\NormalTok{: }\FloatTok{0.1}\NormalTok{,}
    \StringTok{"num_leaves"}\NormalTok{: }\DecValTok{30}\NormalTok{,}
    \StringTok{"max_depth"}\NormalTok{: }\DecValTok{5}
\NormalTok{\}}

\NormalTok{lgb_theta_par }\OperatorTok{=}\NormalTok{ \{}
    \StringTok{"metric"}\NormalTok{: }\StringTok{"rmse"}\NormalTok{,}
    \StringTok{"learning_rate"}\NormalTok{: }\FloatTok{0.1}\NormalTok{,}
    \StringTok{"num_leaves"}\NormalTok{: }\DecValTok{30}\NormalTok{,}
    \StringTok{"max_depth"}\NormalTok{: }\DecValTok{3}
\NormalTok{\}}

\NormalTok{modelTXZ }\OperatorTok{=}\NormalTok{ lgb.LGBMClassifier(}\OperatorTok{**}\NormalTok{lgb_TXZ_par)}
\NormalTok{modelYX }\OperatorTok{=}\NormalTok{ lgb.LGBMRegressor(}\OperatorTok{**}\NormalTok{lgb_YX_par)}
\NormalTok{modelZX }\OperatorTok{=}\NormalTok{ lgb.LGBMClassifier(}\OperatorTok{**}\NormalTok{lgb_TXZ_par)}
\CommentTok{# Modelo inicial para o efeito heterogeneo}
\CommentTok{# Sera melhorado pelo algoritmo Double Robust IV}
\NormalTok{pre_theta }\OperatorTok{=}\NormalTok{ lgb.LGBMRegressor(}\OperatorTok{**}\NormalTok{lgb_theta_par)}

\CommentTok{## Modelo 2-stages Least Squares}

\CommentTok{# Variaveis com amostra completa}
\NormalTok{Z }\OperatorTok{=}\NormalTok{ iv[[}\StringTok{"mailing"}\NormalTok{, }\StringTok{"threat"}\NormalTok{, }\StringTok{"info"}\NormalTok{, }\StringTok{"appeal"}\NormalTok{, }\StringTok{"i_tinf"}\NormalTok{, }\StringTok{"i_tapp"}\NormalTok{]]}
\NormalTok{T }\OperatorTok{=}\NormalTok{ Z.multiply(iv[}\StringTok{"delivered"}\NormalTok{], axis}\OperatorTok{=}\DecValTok{0}\NormalTok{)}
\NormalTok{Y }\OperatorTok{=}\NormalTok{ iv[}\StringTok{"resp_A"}\NormalTok{]}
\NormalTok{model_2sls }\OperatorTok{=}\NormalTok{ IV2SLS(Y, exog}\OperatorTok{=}\NormalTok{np.ones(}\BuiltInTok{len}\NormalTok{(Y)), endog}\OperatorTok{=}\NormalTok{T, instruments}\OperatorTok{=}\NormalTok{Z)}
\NormalTok{iv2sls_fit }\OperatorTok{=}\NormalTok{ model_2sls.fit(debiased}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{iv2sls_params}\OperatorTok{=}\NormalTok{iv2sls_fit.params[[}\StringTok{"mailing"}\NormalTok{, }\StringTok{"threat"}\NormalTok{, }\StringTok{"info"}\NormalTok{, }\StringTok{"appeal"}\NormalTok{]]}
\CommentTok{# Soma os valores para ter mesma interpretacao que DML e DRIV}
\NormalTok{iv2sls_params[}\StringTok{"threat"}\NormalTok{]}\OperatorTok{=}\NormalTok{iv2sls_params[}\StringTok{"threat"}\NormalTok{]}\OperatorTok{+}\NormalTok{iv2sls_params[}\StringTok{"mailing"}\NormalTok{]}
\NormalTok{iv2sls_params[}\StringTok{"info"}\NormalTok{]}\OperatorTok{=}\NormalTok{iv2sls_params[}\StringTok{"info"}\NormalTok{]}\OperatorTok{+}\NormalTok{iv2sls_params[}\StringTok{"mailing"}\NormalTok{]}
\NormalTok{iv2sls_params[}\StringTok{"appeal"}\NormalTok{]}\OperatorTok{=}\NormalTok{iv2sls_params[}\StringTok{"appeal"}\NormalTok{]}\OperatorTok{+}\NormalTok{iv2sls_params[}\StringTok{"mailing"}\NormalTok{]}
\NormalTok{treatments_list}\OperatorTok{=}\NormalTok{[}\StringTok{"Correio"}\NormalTok{, }\StringTok{"Ameaça"}\NormalTok{, }\StringTok{"Info"}\NormalTok{, }\StringTok{"Moral"}\NormalTok{]}
\NormalTok{iv2sls_effect}\OperatorTok{=}\NormalTok{pd.DataFrame(\{}\StringTok{"LATE"}\NormalTok{: iv2sls_params.values\}, index}\OperatorTok{=}\NormalTok{treatments_list)}

\CommentTok{## Modelo DRIV}

\CommentTok{# Treina o modelo DRIV mais flexivel. Theta(X) pode ser um modelo}
\CommentTok{# flexivel (nao parametrico, ie. floresta aleatoria) de X}
\CommentTok{# ATENCAO: leva bastante tempo para rodar}
\NormalTok{driv1 }\OperatorTok{=}\NormalTok{ IntentToTreatDRIV(}
\NormalTok{    model_Y_X}\OperatorTok{=}\NormalTok{modelYX,}
\NormalTok{    model_T_XZ}\OperatorTok{=}\NormalTok{modelTXZ,}
\NormalTok{    flexible_model_effect}\OperatorTok{=}\NormalTok{pre_theta,}
\NormalTok{    n_splits}\OperatorTok{=}\DecValTok{3}\NormalTok{,}
\NormalTok{    featurizer}\OperatorTok{=}\VariableTok{None} \CommentTok{#PolynomialFeatures(degree=1, include_bias=False)}
\NormalTok{)}
\CommentTok{# Mesmo modelo para cada tratamento}
\NormalTok{driv2}\OperatorTok{=}\NormalTok{deepcopy(driv1)}
\NormalTok{driv3}\OperatorTok{=}\NormalTok{deepcopy(driv1)}
\NormalTok{driv5}\OperatorTok{=}\NormalTok{deepcopy(driv1)}

\CommentTok{# DRIV para T1}
\BuiltInTok{print}\NormalTok{(}\StringTok{"Iniciando fit de DRIV T1}\CharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{driv1.fit(Y1, T1, Z}\OperatorTok{=}\NormalTok{Z1, X}\OperatorTok{=}\NormalTok{X1, inference}\OperatorTok{=}\StringTok{"bootstrap"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\StringTok{"Fim do fit de DRIV T1}\CharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{driv1_eff}\OperatorTok{=}\NormalTok{driv1.effect(X1, T0}\OperatorTok{=}\DecValTok{0}\NormalTok{, T1}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"LATE T1 por DRIV: }\SpecialCharTok{\{np.}\NormalTok{mean(driv1_eff)}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\StringTok{"Iniciando inferencia de DRIV T1}\CharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{driv1_inf}\OperatorTok{=}\NormalTok{driv1.effect_inference(X_eval)}
\BuiltInTok{print}\NormalTok{(}\StringTok{"Fim da inferencia de DRIV T1}\CharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{driv1_summary}\OperatorTok{=}\NormalTok{driv1_inf.summary_frame(alpha}\OperatorTok{=}\FloatTok{0.05}\NormalTok{)[[}\StringTok{"point_estimate"}\NormalTok{, }\StringTok{"pvalue"}\NormalTok{, }\StringTok{"stderr"}\NormalTok{]]}
\NormalTok{driv1_summary.index}\OperatorTok{=}\NormalTok{X_eval.index}
\NormalTok{driv1_summary[}\StringTok{"star"}\NormalTok{]}\OperatorTok{=}\NormalTok{driv1_summary[}\StringTok{"pvalue"}\NormalTok{].}\BuiltInTok{apply}\NormalTok{(stars)}
\NormalTok{driv1_summary[}\StringTok{"point_estimate"}\NormalTok{]}\OperatorTok{=}\NormalTok{driv1_summary[}\StringTok{"point_estimate"}\NormalTok{].}\BuiltInTok{apply}\NormalTok{(format_float, digits}\OperatorTok{=}\DecValTok{4}\NormalTok{)}
\NormalTok{driv1_summary[}\StringTok{"point_estimate"}\NormalTok{]}\OperatorTok{=}\NormalTok{driv1_summary[}\StringTok{"point_estimate"}\NormalTok{].}\BuiltInTok{str}\NormalTok{.cat(driv1_summary[}\StringTok{"star"}\NormalTok{])}
\NormalTok{driv1_summary[}\StringTok{"stderr"}\NormalTok{]}\OperatorTok{=}\NormalTok{driv1_summary[}\StringTok{"stderr"}\NormalTok{].}\BuiltInTok{apply}\NormalTok{(surr_parenthesis, digits}\OperatorTok{=}\DecValTok{4}\NormalTok{)}
\NormalTok{driv1_summary}\OperatorTok{=}\NormalTok{driv1_summary[[}\StringTok{"point_estimate"}\NormalTok{, }\StringTok{"stderr"}\NormalTok{]].stack()}
\NormalTok{driv1_summary.name}\OperatorTok{=}\StringTok{"Correio"}
\CommentTok{# Melhora o consumo de memoria}
\KeywordTok{del}\NormalTok{ driv1}
\NormalTok{collected}\OperatorTok{=}\NormalTok{gc.collect()}

\CommentTok{# DRIV para T2}
\BuiltInTok{print}\NormalTok{(}\StringTok{"Iniciando fit de DRIV T2}\CharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{driv2.fit(Y2, T2, Z}\OperatorTok{=}\NormalTok{Z2, X}\OperatorTok{=}\NormalTok{X2, inference}\OperatorTok{=}\StringTok{"bootstrap"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\StringTok{"Fim do fit de DRIV T2}\CharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{driv2_eff}\OperatorTok{=}\NormalTok{driv2.effect(X2, T0}\OperatorTok{=}\DecValTok{0}\NormalTok{, T1}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"LATE T2 por DRIV: }\SpecialCharTok{\{np.}\NormalTok{mean(driv2_eff)}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\StringTok{"Iniciando inferencia de DRIV T2}\CharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{driv2_inf}\OperatorTok{=}\NormalTok{driv2.effect_inference(X_eval)}
\BuiltInTok{print}\NormalTok{(}\StringTok{"Fim da inferencia de DRIV T2}\CharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{driv2_summary}\OperatorTok{=}\NormalTok{driv2_inf.summary_frame(alpha}\OperatorTok{=}\FloatTok{0.05}\NormalTok{)[[}\StringTok{"point_estimate"}\NormalTok{, }\StringTok{"pvalue"}\NormalTok{, }\StringTok{"stderr"}\NormalTok{]]}
\NormalTok{driv2_summary.index}\OperatorTok{=}\NormalTok{X_eval.index}
\NormalTok{driv2_summary[}\StringTok{"star"}\NormalTok{]}\OperatorTok{=}\NormalTok{driv2_summary[}\StringTok{"pvalue"}\NormalTok{].}\BuiltInTok{apply}\NormalTok{(stars)}
\NormalTok{driv2_summary[}\StringTok{"point_estimate"}\NormalTok{]}\OperatorTok{=}\NormalTok{driv2_summary[}\StringTok{"point_estimate"}\NormalTok{].}\BuiltInTok{apply}\NormalTok{(format_float, digits}\OperatorTok{=}\DecValTok{4}\NormalTok{)}
\NormalTok{driv2_summary[}\StringTok{"point_estimate"}\NormalTok{]}\OperatorTok{=}\NormalTok{driv2_summary[}\StringTok{"point_estimate"}\NormalTok{].}\BuiltInTok{str}\NormalTok{.cat(driv2_summary[}\StringTok{"star"}\NormalTok{])}
\NormalTok{driv2_summary[}\StringTok{"stderr"}\NormalTok{]}\OperatorTok{=}\NormalTok{driv2_summary[}\StringTok{"stderr"}\NormalTok{].}\BuiltInTok{apply}\NormalTok{(surr_parenthesis, digits}\OperatorTok{=}\DecValTok{4}\NormalTok{)}
\NormalTok{driv2_summary}\OperatorTok{=}\NormalTok{driv2_summary[[}\StringTok{"point_estimate"}\NormalTok{, }\StringTok{"stderr"}\NormalTok{]].stack()}
\NormalTok{driv2_summary.name}\OperatorTok{=}\StringTok{"Ameaça"}
\CommentTok{# Interpretacao causal por arvore de decisao}
\NormalTok{interp }\OperatorTok{=}\NormalTok{ SingleTreeCateInterpreter(}
\NormalTok{    include_model_uncertainty}\OperatorTok{=}\VariableTok{False}\NormalTok{, }
\NormalTok{    max_depth}\OperatorTok{=}\DecValTok{3}\NormalTok{, }
\NormalTok{    min_samples_leaf}\OperatorTok{=}\DecValTok{10}
\NormalTok{)}
\NormalTok{interp.interpret(driv2, X2)}
\NormalTok{fig, ax1 }\OperatorTok{=}\NormalTok{ plt.subplots(figsize}\OperatorTok{=}\NormalTok{(}\DecValTok{25}\NormalTok{,}\DecValTok{6}\NormalTok{))}
\NormalTok{interp.plot(feature_names}\OperatorTok{=}\NormalTok{X2.columns, fontsize}\OperatorTok{=}\DecValTok{12}\NormalTok{, ax}\OperatorTok{=}\NormalTok{ax1)}
\NormalTok{fig.savefig(}\StringTok{"Figs/fig_tree_driv.png"}\NormalTok{)}
\CommentTok{# Melhora o consumo de memoria}
\KeywordTok{del}\NormalTok{ driv2}
\NormalTok{collected}\OperatorTok{=}\NormalTok{gc.collect()}

\CommentTok{# DRIV para T3}
\NormalTok{driv3.fit(Y3, T3, Z}\OperatorTok{=}\NormalTok{Z3, X}\OperatorTok{=}\NormalTok{X3, inference}\OperatorTok{=}\StringTok{"bootstrap"}\NormalTok{)}
\NormalTok{driv3_eff}\OperatorTok{=}\NormalTok{driv3.effect(X3, T0}\OperatorTok{=}\DecValTok{0}\NormalTok{, T1}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"LATE T3 por DRIV: }\SpecialCharTok{\{np.}\NormalTok{mean(driv3_eff)}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{)}
\NormalTok{driv3_inf}\OperatorTok{=}\NormalTok{driv3.effect_inference(X_eval)}
\BuiltInTok{print}\NormalTok{(}\StringTok{"Fim da inferencia de DRIV T3}\CharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{driv3_summary}\OperatorTok{=}\NormalTok{driv3_inf.summary_frame(alpha}\OperatorTok{=}\FloatTok{0.05}\NormalTok{)[[}\StringTok{"point_estimate"}\NormalTok{, }\StringTok{"pvalue"}\NormalTok{, }\StringTok{"stderr"}\NormalTok{]]}
\NormalTok{driv3_summary.index}\OperatorTok{=}\NormalTok{X_eval.index}
\NormalTok{driv3_summary[}\StringTok{"star"}\NormalTok{]}\OperatorTok{=}\NormalTok{driv3_summary[}\StringTok{"pvalue"}\NormalTok{].}\BuiltInTok{apply}\NormalTok{(stars)}
\NormalTok{driv3_summary[}\StringTok{"point_estimate"}\NormalTok{]}\OperatorTok{=}\NormalTok{driv3_summary[}\StringTok{"point_estimate"}\NormalTok{].}\BuiltInTok{apply}\NormalTok{(format_float, digits}\OperatorTok{=}\DecValTok{4}\NormalTok{)}
\NormalTok{driv3_summary[}\StringTok{"point_estimate"}\NormalTok{]}\OperatorTok{=}\NormalTok{driv3_summary[}\StringTok{"point_estimate"}\NormalTok{].}\BuiltInTok{str}\NormalTok{.cat(driv3_summary[}\StringTok{"star"}\NormalTok{])}
\NormalTok{driv3_summary[}\StringTok{"stderr"}\NormalTok{]}\OperatorTok{=}\NormalTok{driv3_summary[}\StringTok{"stderr"}\NormalTok{].}\BuiltInTok{apply}\NormalTok{(surr_parenthesis, digits}\OperatorTok{=}\DecValTok{4}\NormalTok{)}
\NormalTok{driv3_summary}\OperatorTok{=}\NormalTok{driv3_summary[[}\StringTok{"point_estimate"}\NormalTok{, }\StringTok{"stderr"}\NormalTok{]].stack()}
\NormalTok{driv3_summary.name}\OperatorTok{=}\StringTok{"Info"}
\CommentTok{# Melhora o consumo de memoria}
\KeywordTok{del}\NormalTok{ driv3}
\NormalTok{collected}\OperatorTok{=}\NormalTok{gc.collect()}

\CommentTok{# DRIV para T5}
\NormalTok{driv5.fit(Y5, T5, Z}\OperatorTok{=}\NormalTok{Z5, X}\OperatorTok{=}\NormalTok{X5, inference}\OperatorTok{=}\StringTok{"bootstrap"}\NormalTok{)}
\NormalTok{driv5_eff}\OperatorTok{=}\NormalTok{driv5.effect(X5, T0}\OperatorTok{=}\DecValTok{0}\NormalTok{, T1}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"LATE T5 por DRIV: }\SpecialCharTok{\{np.}\NormalTok{mean(driv5_eff)}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{)}
\NormalTok{driv5_inf}\OperatorTok{=}\NormalTok{driv5.effect_inference(X_eval)}
\BuiltInTok{print}\NormalTok{(}\StringTok{"Fim da inferencia de DRIV T5}\CharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{driv5_summary}\OperatorTok{=}\NormalTok{driv5_inf.summary_frame(alpha}\OperatorTok{=}\FloatTok{0.05}\NormalTok{)[[}\StringTok{"point_estimate"}\NormalTok{, }\StringTok{"pvalue"}\NormalTok{, }\StringTok{"stderr"}\NormalTok{]]}
\NormalTok{driv5_summary.index}\OperatorTok{=}\NormalTok{X_eval.index}
\NormalTok{driv5_summary[}\StringTok{"star"}\NormalTok{]}\OperatorTok{=}\NormalTok{driv5_summary[}\StringTok{"pvalue"}\NormalTok{].}\BuiltInTok{apply}\NormalTok{(stars)}
\NormalTok{driv5_summary[}\StringTok{"point_estimate"}\NormalTok{]}\OperatorTok{=}\NormalTok{driv5_summary[}\StringTok{"point_estimate"}\NormalTok{].}\BuiltInTok{apply}\NormalTok{(format_float, digits}\OperatorTok{=}\DecValTok{4}\NormalTok{)}
\NormalTok{driv5_summary[}\StringTok{"point_estimate"}\NormalTok{]}\OperatorTok{=}\NormalTok{driv5_summary[}\StringTok{"point_estimate"}\NormalTok{].}\BuiltInTok{str}\NormalTok{.cat(driv5_summary[}\StringTok{"star"}\NormalTok{])}
\NormalTok{driv5_summary[}\StringTok{"stderr"}\NormalTok{]}\OperatorTok{=}\NormalTok{driv5_summary[}\StringTok{"stderr"}\NormalTok{].}\BuiltInTok{apply}\NormalTok{(surr_parenthesis, digits}\OperatorTok{=}\DecValTok{4}\NormalTok{)}
\NormalTok{driv5_summary}\OperatorTok{=}\NormalTok{driv5_summary[[}\StringTok{"point_estimate"}\NormalTok{, }\StringTok{"stderr"}\NormalTok{]].stack()}
\NormalTok{driv5_summary.name}\OperatorTok{=}\StringTok{"Moral"}
\CommentTok{# Melhora o consumo de memoria}
\KeywordTok{del}\NormalTok{ driv5}
\NormalTok{collected}\OperatorTok{=}\NormalTok{gc.collect()}

\CommentTok{# LATE}
\NormalTok{driv_late}\OperatorTok{=}\NormalTok{[np.mean(x) }\ControlFlowTok{for}\NormalTok{ x }\KeywordTok{in} 
\NormalTok{    [driv1_eff, driv2_eff, driv3_eff, driv5_eff]]}
\NormalTok{treatments_list}\OperatorTok{=}\NormalTok{[}\StringTok{"Correio"}\NormalTok{, }\StringTok{"Ameaça"}\NormalTok{, }\StringTok{"Info"}\NormalTok{, }\StringTok{"Moral"}\NormalTok{]}
\NormalTok{driv_effect}\OperatorTok{=}\NormalTok{pd.DataFrame(\{}\StringTok{"LATE"}\NormalTok{: driv_late\}, index}\OperatorTok{=}\NormalTok{treatments_list)}
\CommentTok{# driv_effect.to_latex(}
\CommentTok{#     buf="Tables/tab_driv_late.tex",}
\CommentTok{#     decimal=",",}
\CommentTok{#     caption="LATE estimado por Doubly Robust IV para diferentes tratamentos.",}
\CommentTok{#     label="tab:driv-late"}
\CommentTok{# )}

\CommentTok{# Junta todos os efeitos em uma tabela unica}
\NormalTok{all_effects}\OperatorTok{=}\NormalTok{(dml_effect}
\NormalTok{    .merge(iv2sls_effect, left_index}\OperatorTok{=}\VariableTok{True}\NormalTok{, right_index}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{    .merge(driv_effect, left_index}\OperatorTok{=}\VariableTok{True}\NormalTok{, right_index}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{)}
\NormalTok{mindex}\OperatorTok{=}\NormalTok{pd.MultiIndex.from_tuples([}
\NormalTok{    (}\StringTok{"ForestDML"}\NormalTok{, }\StringTok{"ATE"}\NormalTok{), }
\NormalTok{    (}\StringTok{"ForestDML"}\NormalTok{, }\StringTok{"ATT"}\NormalTok{), }
\NormalTok{    (}\StringTok{"IV2SLS"}\NormalTok{, }\StringTok{"LATE"}\NormalTok{), }
\NormalTok{    (}\StringTok{"DRIV"}\NormalTok{, }\StringTok{"LATE"}\NormalTok{)], }
\NormalTok{    names}\OperatorTok{=}\NormalTok{[}\StringTok{"Modelo"}\NormalTok{, }\StringTok{"Efeito"}\NormalTok{])}
\NormalTok{all_effects.columns}\OperatorTok{=}\NormalTok{mindex}
\NormalTok{all_effects.to_latex(}
\NormalTok{    buf}\OperatorTok{=}\StringTok{"Tables/tab_all_effects.tex"}\NormalTok{,}
\NormalTok{    decimal}\OperatorTok{=}\StringTok{","}\NormalTok{,}
\NormalTok{    caption}\OperatorTok{=}\StringTok{"Efeitos médios dos tratamentos estimados pelos métodos de ForestDML, IV2SLS e DRIV."}\NormalTok{,}
\NormalTok{    label}\OperatorTok{=}\StringTok{"tab:all-effects"}\NormalTok{,}
\NormalTok{    float_format}\OperatorTok{=}\StringTok{"}\SpecialCharTok{%.4f}\StringTok{"}\NormalTok{,}
\NormalTok{    multirow}\OperatorTok{=}\VariableTok{True}\NormalTok{,}
\NormalTok{    multicolumn}\OperatorTok{=}\VariableTok{True}\NormalTok{,}
\NormalTok{    multicolumn_format}\OperatorTok{=}\StringTok{"c"}
\NormalTok{)}

\CommentTok{# Sumario com os resultados para os 4 tratamentos}
\NormalTok{driv_summary}\OperatorTok{=}\NormalTok{(}
\NormalTok{    pd.concat(}
\NormalTok{        [driv1_summary, driv2_summary, driv3_summary, driv5_summary],}
\NormalTok{        axis}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
\NormalTok{    .reset_index()}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{\{}\StringTok{"level_0"}\NormalTok{: }\StringTok{"X"}\NormalTok{\})}
\NormalTok{    .drop(columns}\OperatorTok{=}\StringTok{"level_1"}\NormalTok{)}
\NormalTok{)}

\NormalTok{driv_summary.to_latex(}
\NormalTok{    buf}\OperatorTok{=}\StringTok{"Tables/tab_driv_summary.tex"}\NormalTok{,}
\NormalTok{    decimal}\OperatorTok{=}\StringTok{","}\NormalTok{,}
\NormalTok{    caption}\OperatorTok{=}\StringTok{"Efeitos heterogêneos do tratamento estimados por Doubly Robust IV."}\NormalTok{,}
\NormalTok{    label}\OperatorTok{=}\StringTok{"tab:driv-summary"}\NormalTok{,}
\NormalTok{    index}\OperatorTok{=}\VariableTok{False}
\NormalTok{)}
\CommentTok{# Nota: os estágios de previsão foram gradient boosted tree (regressão) para $E[Y|\textbackslash{}bfx]$}
\CommentTok{# e gbm (classificação) $E[T|\textbackslash{}bfx]$. O modelo final para o efeito }
\CommentTok{# condicional do tratamento, $\textbackslash{}theta(\textbackslash{}bfx)$, também foi uma gbm-regressão, porém mais rasa,}
\CommentTok{# com apenas 3 níveis de profundidade.}

\CommentTok{# Salva objetos }
\CommentTok{# with open("modelos.pkl", "wb") as f:}
\CommentTok{#     pickle.dump([model_dml, model_ldriv, model_driv], f)}

\CommentTok{# Carrega objetos}
\CommentTok{# with open("modelos.pkl", "wb") as f:}
\CommentTok{#     model_dml, model_ldriv, model_driv = pickle.load(f)}


\CommentTok{# Floresta Causal}
\CommentTok{# cf=CausalForest(}
\CommentTok{#     n_trees=200,}
\CommentTok{#     min_leaf_size=15,}
\CommentTok{#     max_depth=8,}
\CommentTok{#     model_T=LogisticRegression(),}
\CommentTok{#     model_Y=RandomForestRegressor(),}
\CommentTok{#     discrete_treatment=True,}
\CommentTok{#     random_state=123}
\CommentTok{# )}
\CommentTok{# cf.fit(Y, T, X)}
\CommentTok{# cf_inf=cf.effect_inference(X_eval.values)}
\CommentTok{# cf_const_eff=cf.const_marginal_effect(X)}
\CommentTok{# print(f"ATE por Causal Forest \{np.mean(cf_const_eff)\}")}
\CommentTok{# # cf_eff=cf.effect(X_eval.values)}
\CommentTok{# # cf_lb, cf_ub=cf.effect_interval(X_eval.values)}
\CommentTok{# # cf_dict=\{"Estimate": cf_eff, "LB": cf_lb, "UB": cf_ub\}}
\CommentTok{# # cf_df=pd.DataFrame(cf_dict, index=X_eval.index)}
\CommentTok{# cf_summary=cf_inf.summary_frame(alpha=0.05)}
\CommentTok{# cf_summary.index=X_eval.index}
\CommentTok{# cf_summary}
\CommentTok{# cf_summary.to_latex(}
\CommentTok{#     buf="Tables/tab_cf_summary.tex",}
\CommentTok{#     decimal=",",}
\CommentTok{#     caption="Efeitos heterogêneos do tratamento T1 estimados por Floresta Causal.",}
\CommentTok{#     label="tab:cf-summary"}
\CommentTok{# )}
\CommentTok{# # Floresta causal nao eh muito robusta a especificacao do modelo}
\CommentTok{# # E[Y|X,W] (Random Forest ou Lasso)}

\CommentTok{# # Interpretacao causal por arvore de decisao}
\CommentTok{# interp = SingleTreeCateInterpreter(}
\CommentTok{#     include_model_uncertainty=False, }
\CommentTok{#     max_depth=3, min_samples_leaf=10)}
\CommentTok{# interp.interpret(cf, X)}
\CommentTok{# fig, ax1 = plt.subplots(figsize=(25,6))}
\CommentTok{# interp.plot(feature_names=X_cols, fontsize=12, ax=ax1)}
\CommentTok{# fig.savefig("Figs/fig_tree_cf.png")}

\CommentTok{# ## Modelo DMLATEIV}
\CommentTok{# model_dml = DMLATEIV(}
\CommentTok{#     model_Y_W=modelYX,}
\CommentTok{#     model_T_W=modelTXZ,}
\CommentTok{#     model_Z_W=modelZX,}
\CommentTok{#     discrete_treatment=True,}
\CommentTok{#     discrete_instrument=True,}
\CommentTok{#     n_splits=5}
\CommentTok{# )}
\CommentTok{# model_dml.fit(Y, T, Z, W=None, inference="bootstrap")}
\CommentTok{# model_dml.const_marginal_effect_interval(alpha=0.05)}
\end{Highlighting}
\end{Shaded}

\end{document}
